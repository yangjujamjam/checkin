<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>체크인/아웃</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {font-family:sans-serif;text-align:center;padding-top:50px;}
button{padding:15px;margin:10px;}
</style>
</head>
<body>
<div id="message">확인중...</div>
<button id="checkinBtn" style="display:none;">체크인하기</button>

<script>
const params = new URLSearchParams(location.search);
const room = params.get('room');
const code = params.get('code');
const apiUrl = 'https://script.google.com/macros/s/AKfycbzgDtdvVwoM0TAyXX87JsOjnayb3AK96w6CjPqILw9P7szoo6OdynAQipsTp9MaSFrz/exec';

// JSONP 함수
function jsonp(url,callback){
  const script=document.createElement('script');
  script.src=`${url}&callback=${callback}`;
  document.head.appendChild(script);
}

function handleCodeCheck(data){
  if(data.valid){
    document.getElementById('message').innerText=`${room} 체크인 가능합니다.`;
    document.getElementById('checkinBtn').style.display='inline';
  }else{
    document.getElementById('message').innerText=`잘못되었거나 만료된 링크입니다.`;
  }
}

document.getElementById('checkinBtn').onclick=()=>{
  jsonp(`${apiUrl}?action=expireCode&room=${room}&code=${code}`,'handleExpire');
};

function handleExpire(data){
  if(data.expired){
    document.getElementById('message').innerText=`체크인 완료되었습니다.`;
    document.getElementById('checkinBtn').style.display='none';
  }
}

// 페이지 로드 시 코드 체크
jsonp(`${apiUrl}?action=checkCode&room=${room}&code=${code}`,'handleCodeCheck');
</script>
</body>
</html>
